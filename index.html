<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OKVED Search</title>
    <style>
        #results {
            margin-top: 20px;
        }
    </style>
</head>
<body>

    <h1>OKVED Live Search</h1>

    <label for="okvedCode">OKVED Code:</label>
    <input type="text" id="okvedCode" name="okvedCode" placeholder="Enter OKVED code (e.g., 01.11.1)" maxlength="9">


    

    <div id="results"></div>

    <script>
        const okvedData = [
  {
    "code": "01",
    "name": "Растениеводство и животноводство, охота и предоставление соответствующих услуг в этих областях",
    "subclasses": [
      {
        "code": "01.1",
        "name": "Выращивание однолетних культур",
        "groups": [
          {
            "code": "01.11",
            "name": "Выращивание зерновых (кроме риса), зернобобовых культур и семян масличных культур",
            "subgroups": [
              {
                "code": "01.11.1",
                "name": "Выращивание зерновых культур",            
                  "types": [
                    {
                      "code": "01.11.11",
                      "name": "Выращивание пшеницы",
                    },
                    {
                      "code": "01.11.12",
                      "name": "Выращивание ячменя",
                    },
                  ],
                
              },
            ]
            
          }
        ]
      },
    ],
  },
    {
    "code": "02",
    "name": "Лесоводство и лесозаготовки",
    "subclasses": [
      {
        "code": "02.1",
          "name": "Лесоводство и прочая деятельность, связанная с лесоводством",
          "groups": [
          {
            "code": "02.10",
            "name": "Лесоводство и прочая деятельность, связанная с лесоводством",
            "subgroups": [
              {
                "code": "02.10.1",
                "name": "Лесоводство",
                "types": [
                    {
                        "code": "02.10.11",
                        "name": "Выращивание посадочного материала лесных растений (саженцев, сеянцев)",
                    }
                ]
              }
            ]
          }
        ]
      }
    ]
  },
];

        function organizeResults(results) {
            const organized = {};

            for (const item of results) {
                const codeParts = item.code.split('.');
                let currentLevel = organized;
                let currentCode = "";

                for (let i = 0; i < codeParts.length; i++) {
                    currentCode += (i > 0 ? "." : "") + codeParts[i];

                    if (!currentLevel[currentCode]) {
                        currentLevel[currentCode] = {
                            code: currentCode,
                            name: null,
                            children: {}
                        };
                    }

                    if(i === codeParts.length - 1) {
                      currentLevel[currentCode].name = item.name;
                    } else {
                        currentLevel = currentLevel[currentCode].children;
                    }
                }
            }
            return organized;
        }


        function searchOkved(query) {
            const results = [];

            function traverse(data, parentCode = "") {
               for (const item of data) {
                    if (item.code.startsWith(query)) {                      
                        results.push({ code: item.code, name: item.name });
                    }
                     if(item.subgroups){
                        for (const subgroup of item.subgroups) {
                           if (subgroup.code.startsWith(query)) {
                              results.push({ code: subgroup.code, name: subgroup.name});
                            }
                            if(subgroup.types){
                                traverse(subgroup.types)
                           }
                        }
                    }
                     if (item.types) {
                         traverse(item.types);
                    }
                      if (item.subclasses) {
                        traverse(item.subclasses)
                       }
                       if(item.groups){
                          traverse(item.groups)
                       }
                }
            }            
           traverse(okvedData)            
            for (const item of okvedData) {
              if (item.subclasses) {
                   traverse(item.subclasses)
                }
                if(item.groups){
                   traverse(item.groups)
                }
            }

            return results;
        }

        function displayResults(organizedData, level = 0) {
            const resultsDiv = document.getElementById("results");

              if (Object.keys(organizedData).length === 0) {
                resultsDiv.innerHTML = "<p>No results found.</p>";
                return;
              }
              const ul = document.createElement("ul");
              ul.style.marginLeft = `${level * 20}px`;

              for (const key in organizedData) {
                  const item = organizedData[key];
                  const li = document.createElement("li");
                  li.textContent = `${item.code}: ${item.name || ''}`;

                  if (Object.keys(item.children).length > 0) {
                      const childUl = displayResults(item.children, level + 1);
                      li.appendChild(childUl);
                  }

                  ul.appendChild(li);
              }

              resultsDiv.appendChild(ul);
              return ul
        }

        function clearResults() {
            const resultsDiv = document.getElementById("results");
            resultsDiv.innerHTML = "";
            displayResults({});

        }

        const okvedCodeInput = document.getElementById("okvedCode");

        okvedCodeInput.addEventListener("input", () => {
            const query = okvedCodeInput.value.trim();

            const results = searchOkved(query);
            const organizedResults = organizeResults(results);
            const resultsDiv = document.getElementById("results");
            resultsDiv.innerHTML = "";
            displayResults(organizedResults);
        });
        clearResults();
        

    </script>
</body>
</html>